â­ 2. Thiáº¿t káº¿ cáº£i tiáº¿n (Improved OCR + Vote + Cache Pipeline)

DÆ°á»›i Ä‘Ã¢y lÃ  báº£n nÃ¢ng cáº¥p cÃ³ tÃ­nh thá»±c chiáº¿n cao nháº¥t, tÃ´i tá»•ng há»£p thÃ nh 6 cáº£i tiáº¿n chÃ­nh.

ğŸš€ Cáº£i tiáº¿n A â€” OCR Smart Skip v2 (tá»‘i Æ°u skip nhÆ°ng khÃ´ng sai kÃ©o dÃ i)
âœ” CÃ´ng thá»©c má»›i thay _should_attempt_ocr:
ALWAYS OCR if missing jersey

OCR if frame % ocr_stride == 0     # periodic update
OCR if frame - last_ocr_frame >= refresh_stride
OCR if cache_confidence < 0.60     # low confidence cache
OCR if vote_consensus < 0.55       # vote uncertain
OCR if switch_margin_blocking and miss_count small

âš™ Tham sá»‘ gá»£i Ã½:
ocr_stride = 4
refresh_stride = 18â€“25
low_conf_threshold = 0.60
low_consensus_threshold = 0.55

ğŸ”¥ Lá»£i Ã­ch:

Skip Ä‘Æ°á»£c ~70â€“80% OCR

NhÆ°ng khÃ´ng bao giá» Ä‘á»ƒ sai sá»‘ tá»“n táº¡i hÆ¡n 1 giÃ¢y

LuÃ´n OCR khi pipeline â€œnghi ngá»â€ â†’ tÄƒng Ä‘á»™ tin cáº­y

ğŸš€ Cáº£i tiáº¿n B â€” miss_count chuáº©n xÃ¡c (khÃ´ng tÄƒng khi skip há»£p lÃ½)

Hiá»‡n táº¡i miss_count bá»‹ tÄƒng cáº£ khi skip khÃ´ng pháº£i lá»—i pipeline.

âš’ Thay Ä‘á»•i:
if reading is None and skip_reason != "cache_skip" :
    miss_count += 1
else:
    miss_count stays unchanged

ğŸ”¥ Lá»£i Ã­ch:

KhÃ´ng bao giá» drop jersey do skip

Tráº¡ng thÃ¡i player á»•n Ä‘á»‹nh hÆ¡n

Vote khÃ´ng bá»‹ loÃ£ng vÃ¬ miss_count sai

ğŸš€ Cáº£i tiáº¿n C â€” Vote v2: Há»™i tá»¥ nhanh hÆ¡n + sá»­a sai nhanh hÆ¡n
âœ” 1. Giáº£m history_window
40 â†’ 12â€“16


â†’ pháº£n á»©ng nhanh hÆ¡n khi pose crop tá»‘t.

âœ” 2. Bá» sample cÅ© sau X frames (hard age cutoff)

Thay vÃ¬ chá»‰ dÃ¹ng decay:

if age_frames > 40:
    ignore sample completely


â†’ trÃ¡nh viá»‡c sample cÅ© 3â€“4 giÃ¢y áº£nh hÆ°á»Ÿng vote hiá»‡n táº¡i.

âœ” 3. Giáº£m vote_count_min
vote_count_min = 3
vote_min_support = 3


â†’ 3 láº§n OCR tá»‘t lÃ  Ä‘á»§ confirm.

âœ” 4. consensus tháº¥p + cache sai = force recheck
if confirmed_text exists and consensus < 0.55:
    force OCR every frame until fixed

ğŸ”¥ Lá»£i Ã­ch:

Sá»‘ Ã¡o xuáº¥t hiá»‡n nhanh hÆ¡n

Sai sá»‘ sá»­a trong vÃ²ng â‰¤ 0.5â€“1 giÃ¢y

TrÃ¡nh viá»‡c stuck vÃ o cached wrong number

ğŸš€ Cáº£i tiáº¿n D â€” Switch Logic v2 (Ä‘á»•i sá»‘ Ã¡o Ä‘Ãºng lÃºc)
âœ” Lower switch_margin khi ReID similarity tháº¥p
if reid_similarity < 0.30:
    switch_margin *= 0.6   # dá»… switch hÆ¡n

âœ” Switch logic thÃªm trÆ°á»ng há»£p:
if current_top_consensus - previous_consensus >= 0.15:
    allow switch (override)

âœ” Náº¿u miss_count â‰¥ 2 â†’ bá» qua switch guard

Cam káº¿t nhanh hÆ¡n vÃ¬:

Náº¿u tracker máº¥t sá»‘ Ã¡o vÃ i frames â†’ ráº¥t cÃ³ thá»ƒ crop cÅ© sai.

ğŸš€ Cáº£i tiáº¿n E â€” Pose Fusion: bbox + pose fallback thÃ´ng minh
Váº¥n Ä‘á»:

pose fail â†’ bbox crop nhá» â†’ OCR ráº¥t khÃ³.

Cáº£i tiáº¿n:

Náº¿u pose fail:

fallback_crop = enlarge_bbox(bbox, scale=1.12)


Tá»©c lÃ  crop to hÆ¡n 12% má»—i chiá»u.

Hoáº·c:

use pose for vertical bounds, bbox for horizontal


â†’ crop hÃ¬nh chá»¯ nháº­t á»•n Ä‘á»‹nh hÆ¡n.

ğŸ”¥ Lá»£i Ã­ch:

OCR cháº¥t lÆ°á»£ng cao hÆ¡n

Vote máº«u Ä‘á»“ng nháº¥t hÆ¡n

KhÃ´ng bá»‹ â€œpose fail â†’ OCR saiâ€ quÃ¡ nhiá»u

ğŸš€ Cáº£i tiáº¿n F â€” Cache Ä‘a táº§ng (Layered Cache v2)

Hiá»‡n táº¡i cache chá»‰ lÆ°u:

confirmed_text

confidence

expire_by_ttl

Thay báº±ng 3-layer cache:

ğŸŸ¢ Layer 1: hard_cache (confirmed, high confidence)

TTL dÃ i (150 frames)
DÃ¹ng khi viewpoint á»•n Ä‘á»‹nh.

ğŸŸ¡ Layer 2: soft_cache (unconfirmed but stable consensus)

TTL ngáº¯n (20â€“30 frames)
DÃ¹ng Ä‘á»ƒ giáº£m jitter.

ğŸ”´ Layer 3: transient (recent OCR reading)

TTL ráº¥t ngáº¯n (1â€“2 frames)
DÃ¹ng Ä‘á»ƒ debug skip.

â†’ OCR skip sáº½ dá»±a theo thá»© tá»± Æ°u tiÃªn:

1) if hard_cache valid -> skip
2) else if soft_cache valid -> maybe skip
3) else -> OCR

ğŸ”¥ Lá»£i Ã­ch:

KhÃ´ng sai kÃ©o dÃ i

KhÃ´ng máº¥t sá»‘ khi occlusion

KhÃ´ng flicker sá»‘ liÃªn tá»¥c
