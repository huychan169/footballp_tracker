1. Thiáº¿t káº¿ kiáº¿n trÃºc video Ä‘Æ°á»ng bÃ³ng (ball trajectory video)
Input

tracks["ball"] â†’ bbox bÃ³ng tá»«ng frame

vt.compute_ball(bbox) â†’ tá»a Ä‘á»™ bÃ³ng 2D trong sÃ¢n

FPS: tá»« video gá»‘c hoáº·c máº·c Ä‘á»‹nh 25

Processing

LÆ°u history 150â€“200 frame (tÆ°Æ¡ng Ä‘Æ°Æ¡ng 5â€“7s)

Váº½ trail:

line má»ng 2â€“3 px

mÃ u fading (nháº¡t dáº§n vá» phÃ­a cÅ©)

Ä‘áº§u bÃ³ng ná»•i báº­t (tráº¯ng + viá»n Ä‘en)

Náº¿u máº¥t bÃ³ng â†’ giá»¯ trail nhÆ°ng dc má» dáº§n

Output

Video 2D minimap, vÃ­ dá»¥:

output/ball_trail_2d.mp4

âœ… 2. Cáº­p nháº­t ball_hist cho 5â€“7 giÃ¢y

Trong view_transformer/minimap.py:

self.ball_hist = deque(maxlen=200)  # 200 frames ~ 8 seconds @25fps

âœ… 3. HÃ m váº½ trail (5â€“7 giÃ¢y mÆ°á»£t)

ThÃªm vÃ o view_transformer/minimap.py:

def draw_ball_trail(self, canvas, color=(255, 200, 80)):
    """
    Váº½ live-trail 5â€“7 giÃ¢y (200 frames) cá»§a bÃ³ng.
    Tail fading tá»« cÅ© -> má»›i.
    """
    if len(self.ball_hist) < 2:
        return canvas

    pts = list(self.ball_hist)
    N = len(pts)

    for i in range(1, N):
        x1, y1 = map(int, pts[i-1])
        x2, y2 = map(int, pts[i])

        # Ä‘á»™ má» theo tuá»•i Ä‘iá»ƒm
        alpha = i / N  # Ä‘iá»ƒm gáº§n hiá»‡n táº¡i Ä‘áº­m hÆ¡n
        c = (
            int(color[0] * alpha),
            int(color[1] * alpha),
            int(color[2] * alpha)
        )

        cv2.line(canvas, (x1, y1), (x2, y2), c, 2, cv2.LINE_AA)

    return canvas

âœ… 4. HÃ m xuáº¥t video 2D Heat Map + Ball Trail

Táº¡o file má»›i:
export_ball_trail_video.py

import cv2
import numpy as np

def export_ball_trail_video(
        video_path,
        output_path,
        tracks,
        cam_calib,
        vt,
        fps=25,
        width=1050,
        height=680
):

    # ná»n sÃ¢n 2D (mÃ u xanh lÃ¡ nháº¡t)
    base = np.zeros((height, width, 3), dtype=np.uint8)
    base[:] = (40, 110, 40)

    # má»Ÿ video writer
    out = cv2.VideoWriter(
        output_path,
        cv2.VideoWriter_fourcc(*'mp4v'),
        fps,
        (width, height)
    )

    total_frames = len(tracks["ball"])

    for f in range(total_frames):
        frame_tracks = tracks["ball"][f]

        # clone sÃ¢n
        canvas = base.copy()

        # náº¿u khÃ´ng cÃ³ bÃ³ng -> skip váº½ bÃ³ng vÃ  chá»‰ ghi trail cÅ©
        if len(frame_tracks) == 0:
            vt.update_ball(None)
            canvas = vt.minimap.draw_ball_trail(canvas)
            out.write(canvas)
            continue

        # láº¥y bbox bÃ³ng Ä‘áº§u tiÃªn
        bbox = list(frame_tracks.values())[0]["bbox"]

        # tÃ­nh 2d point
        ball_2d = vt.compute_ball(bbox)

        # lÆ°u vÃ o history
        vt.update_ball(ball_2d)

        # váº½ trail dÃ i 5â€“7 giÃ¢y
        canvas = vt.minimap.draw_ball_trail(canvas)

        # váº½ bÃ³ng hiá»‡n táº¡i (náº¿u cÃ³)
        if ball_2d is not None:
            cx, cy = map(int, ball_2d)
            cv2.circle(canvas, (cx, cy), 8, (255,255,255), -1)   # lÃµi tráº¯ng
            cv2.circle(canvas, (cx, cy), 12, (0,0,0), 2)        # viá»n Ä‘en

        out.write(canvas)

    out.release()
    print("â¬† Xuáº¥t xong video ball trail:", output_path)

âœ… 5. Gá»i tá»« main.py

Sau khi cháº¡y pipeline xong (sau draw_and_save_video_streaming):

from export_ball_trail_video import export_ball_trail_video

export_ball_trail_video(
    video_path=args.video,
    output_path="output/ball_trail_2d.mp4",
    tracks=tracks,
    cam_calib=cam_calib,
    vt=vt,
    fps=fps
)

ğŸ¥ 6. Káº¿t quáº£ video

Video xuáº¥t ra sáº½ hiá»ƒn thá»‹:

âœ¦ Ná»n sÃ¢n 2D (xanh lÃ¡ hoáº·c tráº¯ng)
âœ¦ Quá»¹ Ä‘áº¡o bÃ³ng dÃ i 7 giÃ¢y â†’ fading Ä‘áº¹p máº¯t
âœ¦ BÃ³ng hiá»‡n táº¡i ná»•i báº­t (viá»n Ä‘en + lÃµi tráº¯ng)
âœ¦ KhÃ´ng cÃ³ cáº§u thá»§, khÃ´ng cÃ³ overlay khÃ¡c

HÃ¬nh dung frame vÃ­ dá»¥:

 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚                                         â”‚
 â”‚      (live trail 5â€“7s fade dáº§n)         â”‚
 â”‚         \   \   \    \    â—‹             â”‚
 â”‚           \   \   \    \                â”‚
 â”‚                                         â”‚
 â”‚                                         â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
